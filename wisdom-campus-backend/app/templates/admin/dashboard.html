{% extends "base.html" %}

{% block title %}管理控制台 - 智慧校园学习助手系统{% endblock %}

{% block content %}
<section class="admin-header">
    <h2>管理员控制台</h2>
    <p>欢迎访问管理控制台，您可以在这里管理系统资源和用户。</p>
</section>

<section class="admin-dashboard">
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>用户管理</h3>
            <p>管理系统用户、权限和角色</p>
            <div class="card-actions">
                <button class="btn" id="load-users">加载用户列表</button>
            </div>
            <div class="data-table-container">
                <table id="users-table" class="data-table">
                    <thead>
                        <tr>
                            <th>用户ID</th>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>角色</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5">请点击"加载用户列表"按钮</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="dashboard-card">
            <h3>课程管理</h3>
            <p>管理系统课程和学习资源</p>
            <div class="card-actions">
                <button class="btn" id="load-courses">加载课程列表</button>
            </div>
            <div class="data-table-container">
                <table id="courses-table" class="data-table">
                    <thead>
                        <tr>
                            <th>课程ID</th>
                            <th>课程名称</th>
                            <th>教师</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5">请点击"加载课程列表"按钮</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<section class="system-status">
    <h3>系统状态</h3>
    <div class="status-container">
        <div class="status-item">
            <h4>API状态</h4>
            <p id="api-status">检查中...</p>
        </div>
        <div class="status-item">
            <h4>数据库连接</h4>
            <p id="db-status">检查中...</p>
        </div>
        <div class="status-item">
            <h4>缓存状态</h4>
            <p id="cache-status">检查中...</p>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 加载用户列表
        const loadUsersBtn = document.getElementById('load-users');
        const usersTable = document.getElementById('users-table').querySelector('tbody');
        
        loadUsersBtn.addEventListener('click', async function() {
            try {
                usersTable.innerHTML = '<tr><td colspan="5">加载中...</td></tr>';
                
                const response = await fetch('/api/v1/user/list');
                const data = await response.json();
                
                if (data.success && data.users) {
                    let html = '';
                    data.users.forEach(user => {
                        html += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>
                                <button class="btn-small" data-id="${user.id}">编辑</button>
                                <button class="btn-small btn-danger" data-id="${user.id}">删除</button>
                            </td>
                        </tr>
                        `;
                    });
                    usersTable.innerHTML = html;
                } else {
                    usersTable.innerHTML = '<tr><td colspan="5">加载失败: ' + (data.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                usersTable.innerHTML = '<tr><td colspan="5">加载失败: ' + error.message + '</td></tr>';
            }
        });
        
        // 加载课程列表
        const loadCoursesBtn = document.getElementById('load-courses');
        const coursesTable = document.getElementById('courses-table').querySelector('tbody');
        
        loadCoursesBtn.addEventListener('click', async function() {
            try {
                coursesTable.innerHTML = '<tr><td colspan="5">加载中...</td></tr>';
                
                const response = await fetch('/api/v1/learning/courses');
                const data = await response.json();
                
                if (data.success && data.courses) {
                    let html = '';
                    data.courses.forEach(course => {
                        html += `
                        <tr>
                            <td>${course.id}</td>
                            <td>${course.name}</td>
                            <td>${course.teacher}</td>
                            <td>${course.status}</td>
                            <td>
                                <button class="btn-small" data-id="${course.id}">编辑</button>
                                <button class="btn-small btn-danger" data-id="${course.id}">删除</button>
                            </td>
                        </tr>
                        `;
                    });
                    coursesTable.innerHTML = html;
                } else {
                    coursesTable.innerHTML = '<tr><td colspan="5">加载失败: ' + (data.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                coursesTable.innerHTML = '<tr><td colspan="5">加载失败: ' + error.message + '</td></tr>';
            }
        });
        
        // 检查系统状态
        async function checkSystemStatus() {
            // 检查API状态
            const apiStatus = document.getElementById('api-status');
            try {
                const apiResponse = await fetch('/health');
                const apiData = await apiResponse.json();
                apiStatus.textContent = apiData.status === 'ok' ? '正常运行' : '异常';
                apiStatus.className = apiData.status === 'ok' ? 'status-ok' : 'status-error';
            } catch (error) {
                apiStatus.textContent = '连接失败';
                apiStatus.className = 'status-error';
            }
            
            // 模拟检查数据库和缓存状态
            // 实际应用中应该有专门的API端点
            document.getElementById('db-status').textContent = '正常连接';
            document.getElementById('db-status').className = 'status-ok';
            
            document.getElementById('cache-status').textContent = '正常运行';
            document.getElementById('cache-status').className = 'status-ok';
        }
        
        checkSystemStatus();
    });
</script>
{% endblock %} 